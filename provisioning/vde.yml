---
- name: Set time zone
  hosts: default
  gather_facts: false
  sudo: true
  vars:
    timezone: Europe/Amsterdam

  tasks:
    - name: Set time zone variables
      copy: content='{{ timezone }}'
            dest=/etc/timezone
            owner=root
            group=root
            mode=0644
            backup=yes
      notify:
        - Update time zone

  handlers:
    - name: Update time zone
      command: dpkg-reconfigure --frontend noninteractive tzdata

- name: Install VDE
  hosts: default
  gather_facts: false
  sudo: true

  tasks:
    - name: Update APT cache
      apt: update_cache=yes

    - name: Install GIT
      apt: pkg=git

    - name: Install PHP
      apt: pkg=php5

    - name: Install PHP Curl extension
      apt: pkg=php5-curl

    - name: Install PHP XDebug extension
      apt: pkg=php5-xdebug

    - name: Install PHP MongoDB extension
      apt: pkg=php5-mongo

    - name: Check Composer installation
      stat: path=/usr/local/bin/composer
      register: composer

    - name: Install Composer
      shell: curl -sS https://getcomposer.org/installer | php
      when: composer.stat.islink is not defined or not composer.stat.islink

    - name: Add Composer to bin
      file: dest=/usr/local/bin/composer
            src=/home/vagrant/composer.phar
            state=link
      when: composer.stat.isfile is not defined or not composer.stat.isfile

    - name: Check Docker installation
      stat: path=/usr/bin/docker
      register: docker

    - name: Install Docker
      shell: wget -qO- https://get.docker.com/ | sh
      when: docker.stat.isfile is not defined or not docker.stat.isfile

    - name: Add Docker user group
      shell: groupadd docker || true

    - name: Add user to Docker group
      shell: gpasswd -a vagrant docker

    - name: Restart Docker service
      shell: service docker restart

- name: Prepare VDE projects
  hosts: default
  gather_facts: false
  sudo: false

  tasks:
    - name: Copy GIT configuration
      copy: src=~/.gitconfig
            dest=/home/vagrant/.gitconfig
            force=yes

    - name: 'Librarian: Determine project status'
      stat: path=/home/vagrant/p/librarian
      register: librarian

    - name: 'Librarian: Clone GIT repository'
      local_action: git repo=git@github.com:martyn82/librarian.git
                    dest=../projects/librarian
                    accept_hostkey=true
      when: librarian.stat.isdir is not defined or not librarian.stat.isdir

    - name: 'Librarian: Composer install'
      command: composer install
               chdir=/home/vagrant/p/librarian
